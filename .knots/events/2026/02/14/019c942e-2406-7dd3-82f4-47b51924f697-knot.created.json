{
  "event_id": "019c942e-2406-7dd3-82f4-47b51924f697",
  "occurred_at": "2026-02-14T17:47:21Z",
  "knot_id": "foolery-b3v",
  "type": "knot.created",
  "data": {
    "body": "## Summary\n`AppHeader` can hydrate to a different tree on the client than what SSR produced, triggering React/Next hydration mismatch warnings and forcing client-side regeneration.\n\n## Findings\n1. `useAppStore` reads `localStorage` during store initialization.\n   - `src/stores/app-store.ts:19` (`getStoredActiveRepo`) returns `null` on SSR and localStorage value on client.\n   - `src/stores/app-store.ts:24` (`getStoredFilters`) has the same SSR/client split behavior.\n2. `AppHeader` renders critical UI branches directly from this state.\n   - `src/components/app-header.tsx:176` and `src/components/app-header.tsx:188` toggle `disabled` and `title` using `activeRepo`.\n   - `src/components/app-header.tsx:195` switches between `createButton` and an `Add Repo` link path.\n   - The branch can change element type (`<button>` vs `<a>` via `asChild`) between server and client first render.\n3. The observed stack trace/diff matches this exactly (`disabled=\"\"` vs `disabled={false}`, title text changes, and `<a>` vs `<button>` mismatch).\n\n## Proposed Fix\n1. Make initial client render deterministic with SSR.\n   - Initialize store with SSR-safe defaults only (`activeRepo: null`, `filters: {}`) in `src/stores/app-store.ts`.\n   - Move localStorage hydration into a client-only effect after mount (either explicit `hydrateFromStorage()` action or Zustand persist with controlled rehydrate).\n2. Prevent element-type branch flips before hydration.\n   - In `AppHeader`, gate repo-dependent controls behind a hydration-ready flag, or render a stable fallback that keeps identical element structure through first paint.\n   - Specifically avoid swapping between `Button asChild <Link>` and normal `<Button>` during initial hydration window.\n3. Add regression protection.\n   - Test that loading `/beads` with a saved active repo does not emit hydration mismatch warnings.\n\n## Acceptance Criteria\n- No hydration mismatch warning on initial load of `/beads` in dev or production builds.\n- Server and first client render output for header controls are structurally consistent.\n- Repo-dependent controls update correctly after client hydration completes.",
    "description": "## Summary\n`AppHeader` can hydrate to a different tree on the client than what SSR produced, triggering React/Next hydration mismatch warnings and forcing client-side regeneration.\n\n## Findings\n1. `useAppStore` reads `localStorage` during store initialization.\n   - `src/stores/app-store.ts:19` (`getStoredActiveRepo`) returns `null` on SSR and localStorage value on client.\n   - `src/stores/app-store.ts:24` (`getStoredFilters`) has the same SSR/client split behavior.\n2. `AppHeader` renders critical UI branches directly from this state.\n   - `src/components/app-header.tsx:176` and `src/components/app-header.tsx:188` toggle `disabled` and `title` using `activeRepo`.\n   - `src/components/app-header.tsx:195` switches between `createButton` and an `Add Repo` link path.\n   - The branch can change element type (`<button>` vs `<a>` via `asChild`) between server and client first render.\n3. The observed stack trace/diff matches this exactly (`disabled=\"\"` vs `disabled={false}`, title text changes, and `<a>` vs `<button>` mismatch).\n\n## Proposed Fix\n1. Make initial client render deterministic with SSR.\n   - Initialize store with SSR-safe defaults only (`activeRepo: null`, `filters: {}`) in `src/stores/app-store.ts`.\n   - Move localStorage hydration into a client-only effect after mount (either explicit `hydrateFromStorage()` action or Zustand persist with controlled rehydrate).\n2. Prevent element-type branch flips before hydration.\n   - In `AppHeader`, gate repo-dependent controls behind a hydration-ready flag, or render a stable fallback that keeps identical element structure through first paint.\n   - Specifically avoid swapping between `Button asChild <Link>` and normal `<Button>` during initial hydration window.\n3. Add regression protection.\n   - Test that loading `/beads` with a saved active repo does not emit hydration mismatch warnings.\n\n## Acceptance Criteria\n- No hydration mismatch warning on initial load of `/beads` in dev or production builds.\n- Server and first client render output for header controls are structurally consistent.\n- Repo-dependent controls update correctly after client hydration completes.",
    "source": "source:/private/tmp/beads_for_knots.jsonl",
    "state": "shipped",
    "title": "Fix AppHeader hydration mismatch from localStorage-backed store init",
    "workflow_id": "default"
  }
}
