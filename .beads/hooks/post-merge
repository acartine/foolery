#!/usr/bin/env sh
# bd-shim v1
# bd-hooks-version: 0.55.1
# Custom Beads hook: Dolt-native sync after git merge/pull.

set -u

if ! command -v bd >/dev/null 2>&1; then
  exit 0
fi

repo_root=$(git rev-parse --show-toplevel 2>/dev/null || echo "")
if [ -n "$repo_root" ]; then
  cd "$repo_root" || exit 0
fi

if [ ! -d .beads ]; then
  exit 0
fi

resolve_sync_branch() {
  if [ -n "${BEADS_SYNC_BRANCH:-}" ]; then
    printf '%s\n' "$BEADS_SYNC_BRANCH"
    return 0
  fi

  if [ -f .beads/config.yaml ]; then
    branch_from_config=$(sed -n -E "s/^sync[-.]branch:[[:space:]]*\"?([^\"#[:space:]]+)\"?.*/\1/p" .beads/config.yaml | head -n 1)
    if [ -n "$branch_from_config" ]; then
      printf '%s\n' "$branch_from_config"
      return 0
    fi
  fi

  branch_from_dolt=$(bd sql --csv "SELECT active_branch()" 2>/dev/null | tail -n 1 | tr -d '\r')
  if [ -n "$branch_from_dolt" ]; then
    printf '%s\n' "$branch_from_dolt"
    return 0
  fi

  printf '%s\n' "main"
}

ensure_origin_remote() {
  if bd sql --csv "SELECT name FROM dolt_remotes WHERE name='origin'" 2>/dev/null | tail -n +2 | tr -d '\r' | grep -qx "origin"; then
    return 0
  fi

  origin_url=$(git remote get-url origin 2>/dev/null || echo "")
  if [ -z "$origin_url" ]; then
    echo "Warning: git remote 'origin' is not configured; skipping Dolt pull" >&2
    return 1
  fi

  escaped_origin_url=$(printf '%s' "$origin_url" | sed "s/'/''/g")
  add_out=$(bd sql "CALL DOLT_REMOTE('add', 'origin', '$escaped_origin_url')" 2>&1)
  add_rc=$?
  if [ $add_rc -ne 0 ] && ! printf '%s\n' "$add_out" | grep -qi "already exists"; then
    echo "Warning: failed to configure Dolt remote origin; skipping Dolt pull" >&2
    echo "$add_out" >&2
    return 1
  fi

  return 0
}

branch=$(resolve_sync_branch)

if ! ensure_origin_remote; then
  exit 0
fi

pull_out=$(bd sql "CALL DOLT_PULL('origin','$branch')" 2>&1)
pull_rc=$?
if [ $pull_rc -eq 0 ]; then
  exit 0
fi

if printf '%s\n' "$pull_out" | grep -qi "cannot merge with uncommitted changes"; then
  commit_out=$(bd vc commit -m "hook: post-merge dolt checkpoint" 2>&1)
  commit_rc=$?
  if [ $commit_rc -ne 0 ] && ! printf '%s\n' "$commit_out" | grep -qi "nothing to commit"; then
    echo "Warning: post-merge Dolt checkpoint failed" >&2
    echo "$commit_out" >&2
  fi

  pull_out=$(bd sql "CALL DOLT_PULL('origin','$branch')" 2>&1)
  pull_rc=$?
fi

if [ $pull_rc -ne 0 ]; then
  echo "Warning: post-merge Dolt pull failed" >&2
  echo "$pull_out" >&2
fi

exit 0
