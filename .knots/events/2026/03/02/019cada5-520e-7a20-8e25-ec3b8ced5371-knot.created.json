{
  "event_id": "019cada5-520e-7a20-8e25-ec3b8ced5371",
  "occurred_at": "2026-03-02T08:23:38.766283Z",
  "knot_id": "foolery-af02",
  "type": "knot.created",
  "data": {
    "body": "## Bug\n\nThe take loop stops prematurely after iteration 1 when the beat transitions to an action state like `plan_review`. The stop message says:\n\n```\nTake loop stopped: state \"plan_review\" is not agent-claimable (owner=agent) after 1 iteration(s)\n```\n\n`isAgentClaimable` (in `src/lib/workflows.ts:~592`) requires BOTH:\n1. `isQueueState === true` (state starts with `ready_for_`)\n2. `owner.ownerKind === \"agent\"`\n\nAction states like `plan_review`, `implementation`, `shipment` are NOT queue states, so `isAgentClaimable` is always `false` for them — even when the agent owns them.\n\n## Observed behavior\n\nSession `foolery-c550` (beat: \"beats view: add profile column\"):\n- Iteration 1: agent completes `implementation`, calls `kno next` → advances beat\n- `buildNextTakePrompt` calls `getBackend().get(beatId)` to check state\n- `kno show` returns state `plan_review` (an action state, not `ready_for_plan_review`)\n- `isAgentClaimable` is `false` because `plan_review` is not a queue state\n- Loop stops after 1 iteration\n\n## Expected behavior\n\nThe loop should continue claiming through agent-owned states until it hits a human-owned state or terminal state.\n\n## Root cause investigation needed\n\nTwo possible causes:\n\n1. **`kno next` advances past the queue state directly into the action state.** If `kno next` from `implementation` goes straight to `plan_review` (skipping `ready_for_plan_review`), then `isAgentClaimable` will never be true. Check what `kno next` actually returns and whether it auto-claims the next action state.\n\n2. **`isAgentClaimable` is too restrictive.** It only considers queue states claimable, but the take loop needs to also recognize agent-owned action states as \"continuable\". The fix might be to adjust the stop condition in `buildNextTakePrompt`.\n\n## Key files\n\n- `src/lib/terminal-manager.ts` — `buildNextTakePrompt` (~line 664-710): take loop stop conditions\n- `src/lib/workflows.ts` — `deriveWorkflowRuntimeState` (~line 578-594): computes `isAgentClaimable`\n- `src/lib/workflows.ts` — `ownerForCurrentState` (~line 544-566): maps states to owners\n- `src/lib/backends/knots-backend.ts` — `toBeat` (~line 296-370): converts knot to Beat\n- `src/lib/backends/knots-backend.ts` — `buildTakePrompt` (~line 938-988): calls `kno claim <beatId>`\n\n## Reproduction\n\n1. Create a beat with autopilot profile\n2. Click \"Take!\" on it\n3. Agent completes first iteration (e.g. implementation)\n4. Observe take loop stops with \"not agent-claimable\" even though profile is autopilot\n\n## Context from foolery-08af\n\nNotably, session `foolery-08af` did NOT have this problem — it ran 5 iterations through the full autopilot workflow to SHIPPED. The difference: 08af's `kno show` returned queue states (`ready_for_*`) between iterations, while c550 returned an action state (`plan_review`). This suggests the timing of the `kno show` call matters — if `kno next` auto-advances through the queue state into the action state before `buildNextTakePrompt` reads the state, the loop sees an action state and stops.",
    "profile_id": "autopilot",
    "state": "ready_for_planning",
    "title": "Take loop stops at action states: isAgentClaimable false for agent-owned action states"
  }
}
